FROM jetpackio/devbox:latest AS devbox

# Set /code as the working directory for subsequent commands
WORKDIR /code

# Subsequent commands are run as root
USER root:root

# Create the code directory and change its ownership to user
RUN mkdir -p /code && chown ${DEVBOX_USER}:${DEVBOX_USER} /code

# Subsequent commands are run as user
USER ${DEVBOX_USER}:${DEVBOX_USER}

# Copy files to container
COPY --chown=${DEVBOX_USER}:${DEVBOX_USER} devbox.json devbox.json
COPY --chown=${DEVBOX_USER}:${DEVBOX_USER} devbox.lock devbox.lock

# Execute `devbox run` for 3 commands on r.h.s
# 1. echo once environment has been set up
# 2. Run garbage collection in nix-store
# 3. Run optimisations in nix-store (e.g. remove duplications)
RUN devbox run -- echo "Installed Packages." && nix-store --gc && nix-store --optimise

FROM devbox AS jules

# Download and extract FCM v2021.05.0 from github
# ADD --chown=${DEVBOX_USER}:${DEVBOX_USER} https://github.com/metomi/fcm/archive/refs/tags/2021.05.0.tar.gz /code/fcm
COPY --chown=${DEVBOX_USER}:${DEVBOX_USER} fcm /code/fcm

# Copy JULES source code (TODO: download from source?)
COPY --chown=${DEVBOX_USER}:${DEVBOX_USER} jules /code/jules

# Copy scripts
COPY --chown=${DEVBOX_USER}:${DEVBOX_USER} scripts /code/scripts

# Build JULES
RUN devbox run build

# Create entry point
ENTRYPOINT ["devbox", "run", "jules"]
